name: Payment Request Menu
on:
  issues:
    types: [opened]
permissions:
  issues: write
  pull-requests: write
jobs:
  request:
    runs-on: ubuntu-latest
    steps:
      - name: Payment Request Handler
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const issue = context.payload.issue;
              const issueNumber = issue.number;
              const issueBody = issue.body || '';
              const issueTitle = issue.title || '';
              
              // Check if this is a payment-related issue
              const paymentKeywords = ['payment', 'checkout', 'plan', 'buy', 'purchase'];
              const isPaymentIssue = paymentKeywords.some(keyword => 
                issueTitle.toLowerCase().includes(keyword) || 
                issueBody.toLowerCase().includes(keyword)
              );
              
              if (!isPaymentIssue) {
                console.log('Not a payment issue, skipping');
                return;
              }
              
              // Check for existing payment menu comment
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              
              const hasPaymentMenu = comments.data.some(comment => 
                comment.body.includes('üí≥ Payment Plans Available')
              );
              
              if (hasPaymentMenu) {
                console.log('Payment menu already posted, skipping');
                return;
              }
              
              // GitHub repository URL for creating payment request issues
              const repoOwner = context.repo.owner;
              const repoName = context.repo.repo;
              const githubUrl = `https://github.com/${repoOwner}/${repoName}/issues/new`;
              
              // Post payment menu with issue creation links
              const menuBody = `## üí≥ Payment Plans Available

            Thank you for your interest! Here are our available plans:

            | Plan | Price | Duration | Action |
            |------|-------|----------|--------|
            | **Starter** | $10.00 AUD | 30 days | [Request Payment](${githubUrl}?title=[Payment%20Request]%20Starter%20Plan&body=Plan:%20Starter%20($10.00)%0AEmail:%20%0AName:%20&labels=paylink-request) |
            | **Basic** | $25.00 AUD | 90 days | [Request Payment](${githubUrl}?title=[Payment%20Request]%20Basic%20Plan&body=Plan:%20Basic%20($25.00)%0AEmail:%20%0AName:%20&labels=paylink-request) |
            | **Pro** | $99.00 AUD | 1 year | [Request Payment](${githubUrl}?title=[Payment%20Request]%20Pro%20Plan&body=Plan:%20Pro%20($99.00)%0AEmail:%20%0AName:%20&labels=paylink-request) |

            ### üè¶ Bank Transfer Details

            You can pay directly via bank transfer:

            **Bank Details:**
            - **Bank**: Commonwealth Bank (Australia)
            - **Account Name**: SAMRATH SINGH
            - **BSB**: 062948
            - **Account**: 4760652
            - **BIC/SWIFT**: CTBAAU2S

            ### How it works:
            1. **Click the "Pay Now" link** for your desired plan
            2. **Complete payment** via PayPal (instant) or Bank Transfer (manual verification)
            3. **Receive your license key** via email
            4. **Your customer record** will be automatically created
            5. **A new GitHub issue** will be created with your details

            ### What happens after payment:
            ‚úÖ License key sent via email  
            ‚úÖ Customer record created in our system  
            ‚úÖ GitHub issue created with your details  
            ‚úÖ Admin notified of new customer  

            ### Questions?
            Reply to this issue if you have any questions about the payment process.

            ---

            *üîí All payments are secure and encrypted*`;

              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: menuBody
              });
              
              console.log(`‚úÖ Payment menu posted to issue #${issueNumber}`);
              console.log(`   Checkout URL: ${checkoutUrl}`);
              
              // Label the issue
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['payment-menu-posted']
              });
              
            } catch (error) {
              console.error('‚ùå Error details:', error.message);
              console.error('   Full error:', JSON.stringify(error, null, 2));
              throw error;
            }
