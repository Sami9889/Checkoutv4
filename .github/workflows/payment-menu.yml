name: Payment Request Menu

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  payment-menu:
    runs-on: ubuntu-latest
    # Trigger on ANY issue with "payment", "checkout", or "plan" in title/body
    # OR if labeled with paylink-request
    if: |
      contains(github.event.issue.body, 'payment') ||
      contains(github.event.issue.body, 'checkout') ||
      contains(github.event.issue.body, 'plan') ||
      contains(github.event.issue.title, 'payment') ||
      contains(github.event.issue.title, 'checkout') ||
      contains(github.event.issue.title, 'plan') ||
      contains(github.event.issue.labels.*.name, 'paylink-request')
    
    steps:
      - name: Create Payment Menu Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Use production domain if available, else default
            const serverUrl = process.env.PAYLINK_DOMAIN || 'https://checkout.example.com';
            const issue = context.issue;

            // Build menu content
            const menu = `## üí≥ Payment Plans Available

| Plan | Price | Link |
|------|-------|------|
| **Starter** | \$10.00 AUD | [Pay Now](${serverUrl}/web/checkout.html?plan=starter) |
| **Basic** | \$25.00 AUD | [Pay Now](${serverUrl}/web/checkout.html?plan=basic) |
| **Pro** | \$99.00 AUD | [Pay Now](${serverUrl}/web/checkout.html?plan=pro) |

### How it works:
1. Click the "Pay Now" link for your desired plan
2. Complete payment via PayPal
3. You will receive your license key via email
4. Your customer record will be automatically created
5. Check spam folder if you don't see the license email

### What happens after payment:
‚úÖ License key sent via email
‚úÖ Customer record created in our system
‚úÖ GitHub issue created with your details
‚úÖ Admin notified of new customer

### Questions?
Reply to this issue if you have any questions.`;

            // Check if menu already posted
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
            });

            const menuAlreadyPosted = comments.data.some(c => 
              c.body && c.body.includes('## üí≥ Payment Plans Available')
            );

            if (menuAlreadyPosted) {
              console.log('‚úì Payment menu already posted ‚Äî skipping duplicate');
              return;
            }

            // Post menu comment
            try {
              const comment = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: menu
              });
              
              console.log(`‚úÖ Payment menu posted successfully`);
              console.log(`   Issue: ${context.repo.owner}/${context.repo.repo}#${issue.number}`);
              console.log(`   Comment ID: ${comment.data.id}`);
            } catch (error) {
              console.error('‚ùå Error posting menu:', error.message);
              throw error;
            }
        env:
          PAYLINK_DOMAIN: ${{ secrets.PAYLINK_DOMAIN }}
