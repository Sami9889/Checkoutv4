name: PayLinkBridge - Issue Handler

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  issues: write
  contents: read

jobs:
  process:
    runs-on: ubuntu-latest
    
    steps:
      - name: Handle Payment Requests
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const issue = context.payload.issue;
              const title = (issue.title || '').toLowerCase();
              const body = (issue.body || '').toLowerCase();
              const labels = issue.labels.map(l => l.name.toLowerCase());

              console.log('Processing issue #' + issue.number);
              console.log('Title:', issue.title);
              console.log('Labels:', labels.join(', '));

              // Check if this is a payment-related issue
              const paymentKeywords = [
                'bridge', 
                'paylink', 
                'payment', 
                'checkout', 
                'plan', 
                'purchase',
                'buy',
                'license',
                'transfer'
              ];
              
              const hasPaymentKeyword = paymentKeywords.some(kw => 
                title.includes(kw) || body.includes(kw)
              );
              
              const hasPaymentLabel = labels.some(l => 
                l.includes('paylink') || 
                l.includes('payment') || 
                l.includes('bridge')
              );

              // Skip if not payment-related
              if (!hasPaymentKeyword && !hasPaymentLabel) {
                console.log('Not a payment-related issue, skipping');
                return;
              }

              console.log('‚úÖ Payment-related issue detected');

              // Check if we already commented on this issue
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              });

              const alreadyCommented = comments.data.some(comment => 
                comment.user.login === 'github-actions[bot]' &&
                comment.body.includes('Payment Request Processing')
              );

              if (alreadyCommented) {
                console.log('Already commented on this issue, skipping');
                return;
              }

              // Get server URL - use localhost for now
              const serverUrl = 'http://localhost:4000';

              // Post processing confirmation
              const commentBody = `## üí≥ Payment Request Processing

            Thank you for your payment request! Your request has been received and is being processed.

            ### üîÑ What happens next:

            1. **Review** - Admin will review your request
            2. **Payment Link** - You'll receive a payment link or instructions
            3. **Complete Payment** - Follow the payment instructions
            4. **License Delivery** - Your license key will be sent via email
            5. **GitHub Issue** - A new issue will be created with your customer details

            ### üìã Request Details:

            - **Issue Number**: #${issue.number}
            - **Submitted**: ${new Date().toISOString()}
            - **Status**: Pending Review

            ### üí° Payment Options:

            #### Option 1: PayPal Checkout (Instant)
            [Pay Now via PayPal](${serverUrl}/checkout.html)

            #### Option 2: Bank Transfer (Manual Verification)
            [Get Payment Code for Bank Transfer](${serverUrl}/bank-checkout.html)

            ### üè¶ Bank Transfer Details:

            If you prefer bank transfer:
            - **Bank**: Commonwealth Bank (Australia)
            - **Account Name**: SAMRATH SINGH
            - **BSB**: 062948
            - **Account**: 4760652
            - **BIC/SWIFT**: CTBAAU2S

            **Note**: Include your unique payment code in the transfer reference.

            ### ‚è±Ô∏è Processing Time:

            - **PayPal**: Instant (license delivered immediately)
            - **Bank Transfer**: 2-4 hours (after manual verification)

            ### üìß Support:

            If you have questions, reply to this issue or contact support.

            ---

            *ü§ñ This is an automated response from PayLinkBridge payment system*`;

              // Post the comment
              await github.rest.issues.createComment({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });

              console.log('‚úÖ Posted processing confirmation comment');

              // Add label if not already present
              if (!hasPaymentLabel) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['paylink-request']
                });
                console.log('‚úÖ Added paylink-request label');
              }

            } catch (error) {
              console.error('‚ùå Error in workflow:', error.message);
              console.error('Stack trace:', error.stack);
              throw error;
            }
